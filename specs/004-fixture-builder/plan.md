# Implementation Plan: Fixture Builder

**Branch**: `004-fixture-builder` | **Date**: 2026-02-18 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/004-fixture-builder/spec.md`

## Summary

Replace committed test fixture files with a chainable builder API that generates fixture content programmatically. Two new classes (`ConfigBuilder` for config file content, `FixtureBuilder` for directory structure) plus a `withGeneratedFixture` helper for test execution. Migrate 4 fixture categories incrementally (workers → invalid-task-name → graceful-cancellation → config-format), deleting committed fixtures after each verified migration.

## Technical Context

**Language/Version**: TypeScript strict, ESM only, node22
**Primary Dependencies**: `fixturify` (existing), `vitest` (existing) — no new dependencies
**Storage**: Filesystem (temp directories under `test/__temp__/`)
**Testing**: vitest — run affected test files after each migration
**Target Platform**: Ubuntu, macOS, Windows (cross-platform CI)
**Project Type**: Monorepo (pnpm workspaces) — changes are in `packages/nadle/test/__setup__/`
**Performance Goals**: N/A (test-time tooling)
**Constraints**: 200 lines/file, 50 lines/function, max complexity 10, max 3 params
**Scale/Scope**: ~6 test files migrated, ~20 committed fixture files removed

## Constitution Check

_GATE: Must pass before Phase 0 research. Re-check after Phase 1 design._

| Principle                       | Status | Notes                                                                           |
| ------------------------------- | ------ | ------------------------------------------------------------------------------- |
| I. Code Over Configuration      | N/A    | Test infrastructure, not build logic                                            |
| II. Type Safety First           | PASS   | Builder classes use TypeScript strict, chainable API is fully typed             |
| III. Lightweight and Focused    | PASS   | No new dependencies, builder is test-only (not in bundle), files under 200 LOC  |
| IV. Integration-First Testing   | PASS   | This IS the test infrastructure; verified by running existing integration tests |
| V. Self-Hosting (Dogfooding)    | N/A    | Test tooling doesn't affect self-hosting                                        |
| VI. Modern ESM and Strict       | PASS   | ESM only, PascalCase node imports, no process.cwd()                             |
| VII. Cross-Platform Correctness | PASS   | Uses `node:path` for all path operations, symlinks work on all 3 platforms      |

**Technical Constraints**: 200-line file limit requires splitting into 2 files (`config-builder.ts` ~80 LOC, `fixture-builder.ts` ~90 LOC). `withGeneratedFixture` adds ~30 LOC to existing `fs.ts`.

No violations. No complexity justifications needed.

## Project Structure

### Documentation (this feature)

```text
specs/004-fixture-builder/
├── plan.md
├── spec.md
├── research.md
├── data-model.md
├── quickstart.md
├── contracts/
│   └── builder-api.md
├── checklists/
│   └── requirements.md
└── tasks.md              # Generated by /speckit.tasks
```

### Source Code (repository root)

```text
packages/nadle/test/__setup__/
├── config-builder.ts     # NEW: ConfigBuilder class + config() factory
├── fixture-builder.ts    # NEW: FixtureBuilder class + fixture() factory
├── fs.ts                 # MODIFIED: add withGeneratedFixture()
├── index.ts              # MODIFIED: re-export new modules
├── create-files.ts       # UNCHANGED: existing createNadleConfig stays
├── exec.ts               # UNCHANGED
├── constants.ts          # UNCHANGED
└── ...

packages/nadle/test/
├── options/
│   ├── max-worker.test.ts    # MODIFIED: migrate to builder
│   ├── min-worker.test.ts    # MODIFIED: migrate to builder
│   ├── config.test.ts        # MODIFIED: migrate to builder
│   └── ...
├── features/
│   ├── invalid-task-name.test.ts      # MODIFIED: migrate to builder
│   ├── graceful-cancellation.test.ts  # MODIFIED: migrate to builder
│   └── ...
└── __fixtures__/
    ├── workers/              # DELETED after migration
    ├── invalid-task-name/    # DELETED after migration
    ├── graceful-cancellation/ # DELETED after migration
    ├── esm-ts/               # DELETED after migration
    ├── esm-js/               # DELETED after migration
    ├── cjs-ts/               # DELETED after migration
    ├── cjs-js/               # DELETED after migration
    ├── mixed-ts-js/          # DELETED after migration
    ├── mixed-ts-mts/         # DELETED after migration
    └── ... (remaining fixtures unchanged)
```

**Structure Decision**: All new code lives in the existing `test/__setup__/` directory. Two new files for the builder classes, modifications to two existing files. No new directories needed.

## Migration Plan

### Phase 1: Infrastructure (new files)

1. Create `config-builder.ts` — ConfigBuilder class with `configure()`, `task()`, `taskWithConfig()`, `toString()`; `config()` factory function
2. Create `fixture-builder.ts` — FixtureBuilder class with `packageJson()`, `config()`, `configRaw()`, `file()`, `dir()`, `build()`; `fixture()` factory function; `setNestedPath()` helper
3. Add `withGeneratedFixture()` to `fs.ts` — writes DirJSON to temp dir, creates `node_modules/nadle` symlink, provides `{ exec, cwd }` callback
4. Re-export from `index.ts`

### Phase 2: Migrate workers fixtures (P1 — simplest)

- **Test files**: `max-worker.test.ts`, `min-worker.test.ts`
- **Fixtures removed**: `__fixtures__/workers/` (8 files: package.json + 7 config variants)
- **Approach**: Build all config variants in a single `fixture()` call at file scope, wrap each describe block in `withGeneratedFixture`
- **Verification**: `pnpm -F nadle test max-worker min-worker`

### Phase 3: Migrate invalid-task-name fixtures (P2)

- **Test file**: `invalid-task-name.test.ts`
- **Fixtures removed**: `__fixtures__/invalid-task-name/` (7 files: package.json + 6 named configs)
- **Approach**: Build all 6 named configs via `config().task("invalid-name")`, wrap test in `withGeneratedFixture`
- **Verification**: `pnpm -F nadle test invalid-task-name`

### Phase 4: Migrate graceful-cancellation fixture (P2)

- **Test file**: `graceful-cancellation.test.ts`
- **Fixtures removed**: `__fixtures__/graceful-cancellation/` (2 files: package.json + config)
- **Approach**: Build config with 3 tasks using raw action strings (async/setTimeout/throw), wrap in `withGeneratedFixture`
- **Verification**: `pnpm -F nadle test graceful-cancellation`

### Phase 5: Migrate config-format fixtures (P3)

- **Test file**: `config.test.ts`
- **Fixtures removed**: `__fixtures__/esm-ts/`, `esm-js/`, `cjs-ts/`, `cjs-js/`, `mixed-ts-js/`, `mixed-ts-mts/` (12 files total)
- **Approach**: Generate 6 fixture variants with correct file extensions and package.json types. Use `configRaw()` for non-TS formats. Update snapshots.
- **Verification**: `pnpm -F nadle test config.test -- --update`

### Phase 6: Cleanup

- Delete all removed fixture directories
- Verify full test suite passes
- Update snapshot files if needed

## Key Files Reference

| File                                          | Role                                  |
| --------------------------------------------- | ------------------------------------- |
| `test/__setup__/config-builder.ts`            | NEW: ConfigBuilder class              |
| `test/__setup__/fixture-builder.ts`           | NEW: FixtureBuilder class             |
| `test/__setup__/fs.ts`                        | MODIFY: add withGeneratedFixture      |
| `test/__setup__/index.ts`                     | MODIFY: re-export new modules         |
| `test/__setup__/create-files.ts`              | REFERENCE: existing createNadleConfig |
| `test/__setup__/exec.ts`                      | REFERENCE: createExec, Exec type      |
| `test/__setup__/constants.ts`                 | REFERENCE: tempDir, fixturesDir       |
| `test/options/max-worker.test.ts`             | MIGRATE: first target                 |
| `test/options/min-worker.test.ts`             | MIGRATE: first target                 |
| `test/features/invalid-task-name.test.ts`     | MIGRATE: second target                |
| `test/features/graceful-cancellation.test.ts` | MIGRATE: third target                 |
| `test/options/config.test.ts`                 | MIGRATE: fourth target                |
